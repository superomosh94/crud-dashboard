<div class="table-header">
    <div class="table-title">
        <h2>Products</h2>
        <p>Manage inventory, pricing, and stock levels.</p>
    </div>
    <% if (user.role==='admin' || user.role==='manager' ) { %>
        <div class="table-actions">
            <a href="/products/export/csv" class="btn btn-secondary">
                <i class="fas fa-download"></i> Export CSV
            </a>
            <a href="/products/create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Product
            </a>
        </div>
        <% } %>
</div>

<div class="data-table-container">
    <form action="/products" method="GET" class="table-filters">
        <div class="table-search">
            <i class="fas fa-search"></i>
            <input type="text" name="search" value="<%= search %>" placeholder="Search products...">
        </div>
        <select name="category_id">
            <option value="">All Categories</option>
            <% categories.forEach(cat=> { %>
                <option value="<%= cat.id %>" <%=category_id==cat.id ? 'selected' : '' %>><%= cat.name %>
                </option>
                <% }) %>
        </select>
        <select name="status">
            <option value="">All Statuses</option>
            <% statusOptions.forEach(opt=> { %>
                <option value="<%= opt %>" <%=status==opt ? 'selected' : '' %>><%= opt.replace(/_/g, ' ' ).toUpperCase()
                        %>
                </option>
                <% }) %>
        </select>
        <button type="submit" class="btn btn-secondary btn-sm">Filter</button>
        <a href="/products" class="btn btn-secondary btn-sm">Reset</a>
    </form>

    <table class="data-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% products.forEach(product=> { %>
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <div
                                style="width: 40px; height: 40px; background: var(--gray-light); border-radius: var(--radius-sm); overflow: hidden;">
                                <% if (product.image) { %>
                                    <img src="<%= product.image %>" alt="Product"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                    <% } else { %>
                                        <i class="fas fa-box"
                                            style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gray);"></i>
                                        <% } %>
                            </div>
                            <div style="font-weight: 600;">
                                <%= product.name %>
                            </div>
                        </div>
                    </td>
                    <td><code
                            style="background: var(--gray-light); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;"><%= product.sku %></code>
                    </td>
                    <td>
                        <%= product.category ? product.category.name : 'N/A' %>
                    </td>
                    <td>KSh <%= product.price %>
                    </td>
                    <td>
                        <span
                            style="color: <%= product.quantity <= 10 ? 'var(--danger)' : 'inherit' %>; font-weight: <%= product.quantity <= 10 ? '600' : '400' %>;">
                            <%= product.quantity %>
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-<%= 
                            product.status === 'active' ? 'success' : 
                            product.status === 'out_of_stock' ? 'danger' : 
                            product.status === 'inactive' ? 'secondary' : 'warning' 
                        %>">
                            <%= product.status.replace(/_/g, ' ' ) %>
                        </span>
                    </td>
                    <td class="table-actions-cell">
                        <a href="/products/<%= product.id %>" class="btn-icon view" title="View"><i
                                class="fas fa-eye"></i></a>
                        <% if (user.role==='admin' || user.role==='manager' ) { %>
                            <a href="/products/<%= product.id %>/edit" class="btn-icon edit" title="Edit"><i
                                    class="fas fa-edit"></i></a>
                            <form action="/products/<%= product.id %>?_method=DELETE" method="POST"
                                style="display: inline;"
                                onsubmit="return confirm('Are you sure you want to delete this product?')">
                                <button type="submit" class="btn-icon delete" title="Delete"><i
                                        class="fas fa-trash"></i></button>
                            </form>
                            <% } else { %>
                                <a href="/orders/create?product_id=<%= product.id %>" class="btn-icon view"
                                    title="Purchase" style="color: var(--success);">
                                    <i class="fas fa-shopping-cart"></i>
                                </a>
                                <% } %>
                    </td>
                </tr>
                <% }) %>
        </tbody>
    </table>

    <% if (totalPages> 1) { %>
        <div class="pagination">
            <% for(let i=1; i <=totalPages; i++) { %>
                <a href="/products?page=<%= i %>&search=<%= search %>&category_id=<%= category_id %>&status=<%= status %>"
                    class="<%= currentPage === i ? 'active' : '' %>">
                    <%= i %>
                </a>
                <% } %>
        </div>
        <% } %>
</div>